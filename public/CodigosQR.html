<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Códigos QR de Gafetes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(120deg, #84fab0, #2e9acf);
            color: #333;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #fff;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
        }
        .download-all {
            display: block;
            margin: 20px auto;
            text-align: center;
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 5px;
            background-color: #283fa7;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        }
        .download-all:hover {
            background-color: #218838;
            box-shadow: 0px 6px 8px rgba(0, 0, 0, 0.3);
        }
        .qr-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin: 30px auto;
            max-width: 1200px;
        }
        .qr-item {
            background-color: #fff;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-radius: 10px;
            overflow: hidden;
            width: 220px;
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .qr-item:hover {
            transform: translateY(-5px);
            box-shadow: 0px 6px 8px rgba(0, 0, 0, 0.2);
        }
        .qr-item img {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .qr-item h4 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 10px;
        }
        .qr-item button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .qr-item button:hover {
            background-color: #0056b3;
        }
        footer {
            margin-top: auto;
            padding: 10px;
            text-align: center;
            color: #fff;
            background: rgba(0, 0, 0, 0.5);
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container text-center">
        <h1>Códigos QR de Gafetes</h1>
        <button class="download-all" id="downloadAll">Descargar Todos en ZIP</button>
        <div id="qrContainer" class="qr-container"></div>
    </div>
    <footer>
        &copy; 2024 Tu Empresa | Todos los derechos reservados.
    </footer>

    <script>
        let qrDataArray = []; // Array para almacenar los datos de los QR

        fetch('/AllQR')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener los datos');
                }
                return response.json();
            })
            .then(data => {
                const container = document.getElementById('qrContainer');
                container.innerHTML = '';
                qrDataArray = data; // Guardamos los datos de los QR para uso en el botón ZIP

                if (data.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No hay gafetes registrados.</p>';
                    return;
                }

                data.forEach(({ name, qrCode }) => {
                    const qrItem = document.createElement('div');
                    qrItem.className = 'qr-item';

                    const img = document.createElement('img');
                    img.src = qrCode;
                    img.alt = `QR de ${name}`;

                    const title = document.createElement('h4');
                    title.textContent = name;

                    const downloadButton = document.createElement('button');
                    downloadButton.textContent = 'Descargar QR';
                    downloadButton.className = 'btn btn-primary btn-sm';
                    downloadButton.onclick = () => {
                        const link = document.createElement('a');
                        link.download = `${name}-QR.png`;
                        link.href = qrCode;
                        link.click();
                    };

                    qrItem.appendChild(title);
                    qrItem.appendChild(img);
                    qrItem.appendChild(downloadButton);
                    container.appendChild(qrItem);
                });
            })
            .catch(error => {
                console.error('Error al cargar los códigos QR:', error);
                document.getElementById('qrContainer').innerHTML = '<p class="text-center text-danger">Error al cargar los códigos QR.</p>';
            });

        // Función para descargar todos los QR en un ZIP
        document.getElementById('downloadAll').addEventListener('click', () => {
            if (qrDataArray.length === 0) {
                alert('No hay códigos QR para descargar.');
                return;
            }

            const zip = new JSZip();
            const folder = zip.folder('CodigosQR'); // Creamos una carpeta en el ZIP

            qrDataArray.forEach(({ name, qrCode }) => {
                const base64Data = qrCode.replace(/^data:image\/png;base64,/, ''); // Quitamos el prefijo del Data URL
                folder.file(`${name}-QR.png`, base64Data, { base64: true });
            });

            // Generamos y descargamos el ZIP
            zip.generateAsync({ type: 'blob' }).then(content => {
                saveAs(content, 'CodigosQR.zip');
            });
        });


        // Función para normalizar los nombres (remover tildes y convertir a minúsculas)
        const normalizeText = (text) => {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        };

        // Crear el input de búsqueda y agregarlo al DOM
        const searchInput = document.createElement("input");
        searchInput.type = "text";
        searchInput.placeholder = "Buscar por nombre";
        searchInput.className = "form-control my-3 mx-auto";
        searchInput.style.maxWidth = "400px";
        document.querySelector(".container").insertBefore(searchInput, document.getElementById("qrContainer"));

        // Escuchar el evento de input para filtrar los resultados
        searchInput.addEventListener("input", () => {
            const filter = normalizeText(searchInput.value); // Normalizamos el valor ingresado
            const qrItems = document.querySelectorAll(".qr-item");

            qrItems.forEach((item) => {
                const name = normalizeText(item.querySelector("h4").textContent); // Normalizamos el nombre del elemento
                if (name.includes(filter)) {
                    item.style.display = "block"; // Mostrar si coincide
                } else {
                    item.style.display = "none"; // Ocultar si no coincide
                }
            });
        });

    </script>
</body>
</html>
